#!/usr/bin/env bash

# This script configures the pipelines build agent.

# Constants
BRANCH_NAME_LENGTH_LIMIT=35

echo "Configuring build settings..."

# Support for Bitbucket Pipelines
if [[ "$BITBUCKET_REPO_SLUG" != "" ]]; then
	echo "Detected Bitbucket Pipelines build environment"
	export REPO_OWNER="$BITBUCKET_REPO_OWNER"
	export REPO_NAME="$BITBUCKET_REPO_SLUG"
	export BRANCH_NAME="$BITBUCKET_BRANCH"
	export COMMIT_HASH="$BITBUCKET_COMMIT"
fi

# Support for CircleCI 2.0
if [[ "$CIRCLECI" != "" ]]; then
	echo "Detected CircleCI build environment"
	export REPO_OWNER="$CIRCLE_PROJECT_USERNAME"
	export REPO_NAME="$CIRCLE_PROJECT_REPONAME"
	export BRANCH_NAME="$CIRCLE_BRANCH"
	export COMMIT_HASH="$CIRCLE_SHA1"
fi

# For debug purposes these variables can be set manually.
# If they are empty here, then we cannot proceed.
if [[ "$REPO_OWNER" == "" ]] || [[ "$REPO_NAME" == "" ]] || [[ "$BRANCH_NAME" == "" ]]; then
	echo "Unsupported build environment! Quiting..."
	exit 1
fi

# URL safe branch name
BRANCH_NAME_SAFE="$(echo -n "$BRANCH_NAME" | sed -e 's/[^A-Za-z0-9]/-/g' | awk '{print tolower($0)}')"
# Trim the branch name if longer than BRANCH_NAME_LENGTH_LIMIT and append the md5sum to keep the branch name unique
if (( "${#BRANCH_NAME_SAFE}" > "$BRANCH_NAME_LENGTH_LIMIT" )); then
	BRANCH_NAME_SAFE="$(echo -n "$BRANCH_NAME_SAFE" | cut -c1-30)-$(echo -n "$BRANCH_NAME_SAFE" | md5sum | cut -c1-4)"
fi
export BRANCH_NAME_SAFE

# Trim repo name to 30 characters. If someone has a repo name longer than that, then no mercy for them.
export REPO_NAME_SAFE="${REPO_NAME:0:30}"
export REMOTE_BUILD_DIR="/home/ubuntu/builds/$REPO_NAME_SAFE-$BRANCH_NAME_SAFE"
export COMPOSE_PROJECT_NAME="$REPO_NAME_SAFE-$BRANCH_NAME_SAFE"
export DOCKER_STACK_NAME="$REPO_NAME_SAFE-$BRANCH_NAME_SAFE"

# Use DOCKSAL_HOST (domain name) if set, otherwise use DOCKSAL_HOST_IP (IP) with xip.io
export DOCKSAL_HOST="${DOCKSAL_HOST:-$DOCKSAL_HOST_IP.xip.io}"
sed -i "s/HostName DOCKSAL_HOST/HostName $DOCKSAL_HOST/g" $HOME/.ssh/config

# Use ubuntu as the user by default
export DOCKSAL_HOST_USER="${DOCKSAL_HOST_USER:-ubuntu}"
sed -i "s/User DOCKSAL_HOST_USER/User $DOCKSAL_HOST_USER/g" $HOME/.ssh/config

# Allow setting DOCKSAL_DOMAIN individually from DOCKSAL_HOST. Default to DOCKSAL_HOST if not set.
# This is useful when working with CDNs/ELBs/WAFs/etc (when DOCKSAL_DOMAIN is different from the DOCKSAL_HOST).
export DOCKSAL_DOMAIN="${DOCKSAL_DOMAIN:-$DOCKSAL_HOST}"
# NOTE: The length of any one label in the domain name is limited to between 1 and 63 octets.
export DOMAIN="$BRANCH_NAME_SAFE.$REPO_NAME_SAFE.$DOCKSAL_DOMAIN"

echo "Configuring ssh access..."
(umask  077 ; echo "$CI_SSH_KEY" | base64 -d > $HOME/.ssh/id_rsa)
(umask  077 ; echo "$DOCKSAL_HOST_SSH_KEY" | base64 -d > $HOME/.ssh/docksal_host_id_rsa)

# Configure git
git config --global user.email "${CI_GIT_USER_EMAIL:-ci@docksal.io}"
git config --global user.name "${CI_GIT_USER_NAME:-Docksal CI}"

# Initialize a tunnel to the Docker Engine on DOCKSAL_HOST
if [[ "$DOCKSAL_HOST_TUNNEL" != "" ]]; then
	echo "Setting up a secure tunnel to the Docker Engine on $DOCKSAL_HOST..."
	# Black magic! Remote docker.sock access over SSH tunnel
	# Credits:
	# https://docs.docker.com/docker-for-aws/deploy/#connecting-via-ssh
	# https://gist.github.com/scy/6781836#gistcomment-1559506
	ssh -fM -NL localhost:2374:/var/run/docker.sock docker-host

	echo "Querying Docker Engine..."
	docker --host localhost:2374 version
	# Export local tunnel connection settings if it works
	[[ $? == 0 ]] && export DOCKER_HOST="localhost:2374"
fi
