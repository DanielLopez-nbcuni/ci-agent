#!/usr/bin/env bash

# Posts sandbox environment URL to:
# - Github pull request comment
# - Bitbucket pull request comment
# - Bitbucket Status API
# 
# Call after sandbox provisioning commands in your build script.

# Bitbucket Pipelines: Post sandbox URL to Bitbucket build status API (commit/branch level status)
if [[ "${BITBUCKETCI}" != "" ]] && [[ "${BITBUCKET_TOKEN}" != "" ]]; then
	echo "Posting sandbox URL to Bitbucket Status API..."

	PAYLOAD="{\"key\": \"artifacts\", \"state\": \"SUCCESSFUL\", \"name\": \"Sandbox environment\", \"url\": \"http://${DOMAIN}\"}"
	API_URL="https://api.bitbucket.org/2.0/repositories/${BITBUCKET_REPO_OWNER}/${BITBUCKET_REPO_SLUG}/commit/${BITBUCKET_COMMIT}/statuses/build"
	
	curl -sS --request POST \
		--header "Content-Type: application/json" \
		--user "${BITBUCKET_TOKEN}" \
		--data "${PAYLOAD}" \
		"${API_URL}" >/dev/null
fi

# CircleCI: Post sandbox URL to either Github or Bitbucket Pull Request
if [[ "$CIRCLECI" != "" ]]; then
	# Github
	if [[ "${GIT_REPO_SERVICE}" == "github" ]] && [[ "${GITHUB_TOKEN}" != "" ]] && [[ "${GIT_PR_NUMBER}" != "" ]]; then
		echo "Posting sandbox URL to Github pull request..."
		
		PAYLOAD="{\"body\": \"Sandbox environment: http://${DOMAIN}\"}"
		API_URL="https://api.github.com/repos/${GIT_REPO_OWNER}/${GIT_REPO_NAME}/issues/${GIT_PR_NUMBER}/comments"
		
		curl -sS --request POST "${API_URL}" \
			--header "Content-Type: application/json" \
			--header "Accept: application/vnd.github.v3.full+json" \
			--header "Authorization: token ${GITHUB_TOKEN}" \
			--data "${PAYLOAD}"
	fi

	# Bitbucket
	if [[ "${GIT_REPO_SERVICE}" == "bitbucket" ]] && [[ "${BITBUCKET_TOKEN}" != "" ]] && [[ "${GIT_PR_NUMBER}" != "" ]]; then
		echo "Posting sandbox URL to Bitbucket pull request..."
		
		PAYLOAD="content=Sandbox environment: http://${DOMAIN}"
		# Posting comments to PRs is only available in BB API 1.0
		API_URL="https://api.bitbucket.org/1.0/repositories/${GIT_REPO_OWNER}/${GIT_REPO_NAME}/pullrequests/${GIT_PR_NUMBER}/comments"
		
		curl -sS --request POST "${API_URL}" \
			--user "${BITBUCKET_TOKEN}" \
			--data "${PAYLOAD}"
	fi
fi
