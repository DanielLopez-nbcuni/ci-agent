#!/usr/bin/env bash

# This script sets up a sandbox environment for the build on the remote docker host.

echo "Setting up remote build environment..."
ssh docker-host whoami
# Cleanup
ssh docker-host "(cd $REMOTE_BUILD_DIR && fin rm -f) || true"
ssh docker-host "sudo rm -rf $REMOTE_BUILD_DIR; mkdir -p $REMOTE_BUILD_DIR"
# Checkout sources
ssh docker-host "cd $REMOTE_BUILD_DIR && git clone --branch="$GIT_BRANCH_NAME" --depth 50 $GIT_REPO_URL . && git reset --hard $GIT_COMMIT_HASH && ls -la"
# Configure sandbox settings
echo "Configuring sandbox settings..."
ssh docker-host "cd $REMOTE_BUILD_DIR && echo COMPOSE_PROJECT_NAME=$COMPOSE_PROJECT_NAME | tee -a .docksal/docksal-local.env"
ssh docker-host "cd $REMOTE_BUILD_DIR && echo VIRTUAL_HOST=$DOMAIN | tee -a .docksal/docksal-local.env"
# Basic HTTP Auth
if [[ "${HTTP_USER}" != "" ]] && [[ "${HTTP_PASS}" != "" ]]; then
	ssh docker-host "cd $REMOTE_BUILD_DIR && echo APACHE_BASIC_AUTH_USER=$HTTP_USER | tee -a .docksal/docksal-local.env"
	ssh docker-host "cd $REMOTE_BUILD_DIR && echo APACHE_BASIC_AUTH_PASS=$HTTP_PASS | tee -a .docksal/docksal-local.env"
fi
#echo "Launching fin init..."
#ssh docker-host "cd $REMOTE_BUILD_DIR && fin init"

# Bitbucket Pipelines: Post sandbox URL to Bitbucket build status API (commit/branch level status)
# Note: this happens before the actual sandbox is up and does not reflect the actual sandbox build status.
if [[ "${BITBUCKETCI}" != "" ]] && [[ "${BITBUCKET_TOKEN}" != "" ]]; then
	echo "Posting sandbox URL to Bitbucket Status API..."

	PAYLOAD="{\"key\": \"artifacts\", \"state\": \"SUCCESSFUL\", \"name\": \"Sandbox environment\", \"url\": \"http://${DOMAIN}\"}"
	API_URL="https://api.bitbucket.org/2.0/repositories/${BITBUCKET_REPO_OWNER}/${BITBUCKET_REPO_SLUG}/commit/${BITBUCKET_COMMIT}/statuses/build"
	
	curl -sS --request POST \
		--header "Content-Type: application/json" \
		--user "${BITBUCKET_TOKEN}" \
		--data "${PAYLOAD}" \
		"${API_URL}" >/dev/null
fi

# CircleCI: Post sandbox URL to either Github or Bitbucket Pull Request
# Note: this happens before the actual sandbox is up and does not reflect the actual sandbox build status
if [[ "$CIRCLECI" != "" ]]; then
	# Github
	if [[ "${GIT_REPO_SERVICE}" == "github" ]] && [[ "${GITHUB_TOKEN}" != "" ]] && [[ "${GIT_PR_NUMBER}" != "" ]]; then
		echo "Posting sandbox URL to Github pull request..."
		
		PAYLOAD="{\"body\": \"Sandbox environment: http://${DOMAIN}\"}"
		API_URL="https://api.github.com/repos/${GIT_REPO_OWNER}/${GIT_REPO_NAME}/issues/${GIT_PR_NUMBER}/comments"
		
		curl -sS --request POST \
			--header "Content-Type: application/json" \
			--header "Accept: application/vnd.github.v3.full+json" \
			--header "Authorization: token ${GITHUB_TOKEN}" \
			--data "${PAYLOAD}" \
			"${API_URL}" >/dev/null
	fi

	# Bitbucket
	if [[ "${GIT_REPO_SERVICE}" == "bitbucket" ]] && [[ "${BITBUCKET_TOKEN}" != "" ]] && [[ "${GIT_PR_NUMBER}" != "" ]]; then
		echo "Posting sandbox URL to Bitbucket pull request..."
		
		PAYLOAD="content=Sandbox environment: http://${DOMAIN}"
		# Posting comments to PRs is only available in BB API 1.0
		API_URL="https://api.bitbucket.org/1.0/repositories/${GIT_REPO_OWNER}/${GIT_REPO_NAME}/pullrequests/${GIT_PR_NUMBER}/comments"
		
		curl -sS --request POST "${API_URL}" \
			--user "${BITBUCKET_TOKEN}" \
			--data "${PAYLOAD}"
	fi
fi
